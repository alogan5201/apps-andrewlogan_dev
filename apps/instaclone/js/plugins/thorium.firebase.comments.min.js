/*!
 * Thorium Builder Commenting Plugin for Google cloud.firestore
 * Version 2.2.0 november, 2020
 * framework7 v5.x (https://framework7.io)
 * Google firebase (https://firebase.google.com)
 * framework7: MIT Licensed
 * Copyright 2018-2020 Thorium builder.
*/
var firebaseComments={name:"Thorium Builder Comments Plugin for Firebase",bundleid:"com.thoriumbuilder.firebase.comments",version:"1.0.0",messages:null,messagebar:null,inputHeight:0,openCommentsPopup:function(e){var t=e.target,o=t.getAttribute("data-key");o?(app.preloader.show(),firebaseComments.messages||(firebaseComments.messages=app.messages.create({el:".messages",firstMessageRule:function(e,t,o){return!e.isTitle&&(!t||t.type!==e.type||t.name!==e.name)},lastMessageRule:function(e,t,o){return!e.isTitle&&(!o||o.type!==e.type||o.name!==e.name)},tailMessageRule:function(e,t,o){return!e.isTitle&&(!o||o.type!==e.type||o.name!==e.name)}})),firebaseComments.messagebar||(firebaseComments.messagebar=app.messagebar.create({el:".messagebar"})),firebaseComments.messages.clear(),$(".entercommenttext").attr("data-key",o),$(".entercomment").hide(),$(".entercommenttext").val(""),thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase.comments] Loading Messages for object with ID ["+o+"]"),firestoredb.collection("thorium.comments").doc(o).get().then((function(e){if(e.exists){var o=e.data().comments;for(var r in o){var n,i=o[r];n=i.createdby==firebase.auth().currentUser.uid?"sent":"received";var a="";if(i.createdby!=m){var s=Date.now();a=thoriumCorePlugin.timeDiff(s,i.createddate)}firebaseComments.messages.addMessage({text:i.message,type:n,name:i.createdbyname,avatar:i.createdbyphotourl,footer:a,isTitle:!1});var m=i.createdby}}var l=$(t)[0],c=l.closest(".firebase-virtual-list-content")||null;if(!(c&&0!=c.length||(c=l.closest(".firebase-form")||null))){app.preloader.hide();var u="[com.thoriumbuilder.firebase.comments] Parent Repeater/Displayer not found";return thoriumCorePlugin.logEvent(2,u),void app.dialog.alert(u)}var d=c.getAttribute("data-collection");if(!d)return app.preloader.hide(),void thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.firebase.comments] Parent collection Not found");$(".entercommenttext").attr("data-collection",d);var g=app.popup.create({el:".tb-comments-popup",swipeToClose:!1});firebaseComments.inputHeight=$(".entercommenttext").height(),$(".send-comment").addClass("disabled"),setTimeout((function(){app.preloader.hide(),g.open(!0),$(".entercomment").show(),firebaseComments.messagebar.clear()}),200)})).catch((function(e){app.preloader.hide();var t="[com.thoriumbuilder.firebase.comments] An error occured "+e.message;thoriumCorePlugin.logEvent(2,t),app.dialog.alert(t)}))):thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.firebase.comments] Object ID not set")},addComment:function(e){var t=firebaseComments.messagebar.getValue().replace(/\n/g,"<br>").trim();if(t&&0!=t.length)if(n=firebase.auth().currentUser){var o=$(".entercommenttext").attr("data-key");if(o){var r=$(".entercommenttext").attr("data-collection");if(o){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase.comments] Set Object Comment");Date.now();var n,i={};i.message=t,1==(n=firebase.auth().currentUser).isAnonymous?(i.createdbyname="Anonymous",i.createdbyphotourl="img/defaultavatar.png"):(i.createdbyname=n.displayName,i.createdbyphotourl=n.photoURL),i.createdby=n.uid,i.createdbyemail=n.email,i.createddate=Date.now(),firebaseComments.messages.showTyping({header:i.createdbyname,avatar:i.createdbyphotourl,type:"sent"});var a,s=firestoredb.collection(r).doc(o);s.get().then((function(e){e.exists?(a=e,thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase.comments] Parent Object Found, Updating Counter")):thoriumCorePlugin.logEvent(1,"[com.thoriumbuilder.firebase.comments] Parent Object not Found")})),thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase.comments] Get Record from [thorium.comments] with ID ["+o+"]");var m=firestoredb.collection("thorium.comments").doc(o);m.get().then((function(e){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase.comments] Create Firebase Bach Transaction");var o=firestoredb.batch();if(e.exists?(thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase.comments] Record Found, updating record"),o.update(m,{comments:firebase.firestore.FieldValue.arrayUnion(i)})):(thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase.comments] Record Not Found, Creating record"),o.set(m,{comments:firebase.firestore.FieldValue.arrayUnion(i)})),a&&a.exists){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase.comments] Parent Object Found, Updating Counter");const e=firebase.firestore.FieldValue.increment(1);o.update(s,{thorium_comments_count:e})}thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase.comments] Send Batch Transaction to Firebase"),o.commit().then((function(){setTimeout((function(){firebaseComments.messages.addMessage({text:i.message,type:"sent",name:i.createdbyname,avatar:i.createdbyphotourl,footer:"now",isTitle:!1}),firebaseComments.messages.hideTyping()}),1e3),firebaseComments.messagebar.clear(),$(".send-comment").addClass("disabled"),setTimeout((function(){firebaseComments.messages.scroll(500,$(".tb-comments-popup-content")[0].scrollHeight)}),2e3)})).catch((function(e){firebaseComments.messages.hideTyping(),thoriumCorePlugin.logEvent(2,e.message),app.dialog.alert(t)}))})).catch((function(e){firebaseComments.messages.hideTyping();var t="[com.thoriumbuilder.firebase.comments] An error occured "+e.message;thoriumCorePlugin.logEvent(2,t),app.dialog.alert(t)}))}else thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.firebase.comments] Collection not set")}else thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.firebase.comments] Object ID not set")}else thoriumCorePlugin.logEvent(1,"[com.thoriumbuilder.firebase.comments] not Connected");else thoriumCorePlugin.logEvent(1,"[com.thoriumbuilder.firebase.comments] Message is Null or Empty")},likeItem:function(e){var t=e.target,o=firebase.auth().currentUser;if(!o||1==o.isAnonymous)return thoriumCorePlugin.logEvent(1,"[com.thoriumbuilder.firebase.comments] User Must Sign In"),void app.dialog.alert("You must SignIn first!");var r=$("#"+t.id).closest(".firebase-virtual-list-content")||null;if(!(r&&0!=r.length||(r=$("#"+t.id).closest(".firebase-form")||null)&&0!=r.length))return thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.firebase.comments] Parent List not found"),void app.dialog.alert("Parent List Not Found");var n=r[0].getAttribute("data-collection")||null;if(!n)return thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.firebase.comments] Collection not defined"),void app.dialog.alert("Collection not Defined");t.classList.add("disabled");var i=t.getAttribute("data-key"),a=Date.now(),s=o.uid+i,m=firestoredb.collection("thorium.likes").doc(s),l=null;e.target.getElementsByTagName("span").length>0&&(l=t.getElementsByTagName("span")[0]);var c=null;e.target.getElementsByTagName("i").length>0&&(c=t.getElementsByTagName("i")[0]),m.get().then((function(e){e.exists?app.dialog.confirm("Dislike?",(function(){m.delete().then((function(){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase.comments] Decrement Count Like"),firestoredb.collection(n).doc(i).update({thorium_count_likes:firebase.firestore.FieldValue.increment(-1)}).catch((function(e){thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.firebase.comments] An Error occured: "+e),app.dialog.alert("An Error occured: "+e)})).then((function(){if(c&&(c.classList.remove("text-color-red"),c.innerHTML="heart"),l){var e=parseInt(l.textContent)||0;(e-=1)<1?e="":1==e?e="1 like":e+=" likes",l.textContent=e}t.classList.remove("disabled")}))})).catch((function(e){thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.firebase.comments] An Error occured: "+e),t.classList.remove("disabled"),app.dialog.alert("An Error occured: "+e)}))})):m.set({createdby:o.uid,createddate:a,createdbyname:o.displayName}).catch((function(e){t.classList.remove("disabled"),app.dialog.alert("An Error occured: "+e)})).then((function(){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase.comments] Increment Count Like"),firestoredb.collection(n).doc(i).update({thorium_count_likes:firebase.firestore.FieldValue.increment(1)}).catch((function(e){t.classList.remove("disabled"),app.dialog.alert("An Error occured: "+e),thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.firebase.comments] An Error occured: "+e)})).then((function(e){if(t.classList.remove("disabled"),c&&(c.classList.add("text-color-red"),c.innerHTML="heart_fill"),l){var o=parseInt(l.textContent)||0;(o+=1)<1?o="":1==o?o="1 like":o+=" likes",l.textContent=o}}))}))})).catch((function(e){thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.firebase.comments] An Error occured: "+e),t.classList.remove("disabled"),app.dialog.alert("An Error occured: "+e)}))}};$(document).on("click",".firebase-like",(function(e){e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),firebaseComments.likeItem(e)})),$(document).on("input",".entercommenttext",(function(e){e.preventDefault(),0==$(".entercommenttext").val().length?$(".send-comment").addClass("disabled"):$(".send-comment").removeClass("disabled")})),$(document).on("focus click",".entercommenttext",(function(e){e.preventDefault(),setTimeout((function(){firebaseComments.messages.scroll(500,$(".tb-comments-popup-content")[0].scrollHeight)}),500)})),focus,$(document).on("click",".tb-comments-add",(function(e){e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),firebaseComments.openCommentsPopup(e)})),$(document).on("click",".send-comment",(function(e){e.preventDefault(),firebaseComments.addComment(e)}));
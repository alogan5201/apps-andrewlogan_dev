/*!
 * SQLite functions for Thorium PWA projects
 * Version 2.0 June, 2020
 * use framework7 v5.x (https://framework7.io)
 * framework7: MIT Licensed
 * Copyright 2019-2020 Thorium builder.
*/
var thoriumSqlitePlugin={name:"Thorium Builder SQLite Plugin",bundleid:"com.thoriumbuilder.sqlite",version:"2.0.0",stars:'<i class="fa f7-icons s-3" data-icon="star_fill">star_fill</i>',allowInfinite:!0,mediaRoot:"",setDisplayerContentsFromData:function(e,t){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.sqlite] Set Displayer Content from Data");var a,i,r,o,l,n,s=0,p=0;t.$el.find("[data-displayer=true]").each((function(t,d){$(this).find(".db-field").forEach((function(d){var u=d.outerHTML;for(var m in e){var g=e[m];for(var h in g){var c=g[h]||"";if("img_name"==h&&(null==c||0==c.length||"null"==c?r=c="./img/transparent.png":(r=c,c=thoriumSqlitePlugin.mediaRoot+c)),"audio_file"==h&&(c=thoriumSqlitePlugin.mediaRoot+c),"video_file"==h&&(c=thoriumSqlitePlugin.mediaRoot+c),"latitude"==h&&(s=c),"longitude"==h&&(p=c),"name"==h&&(a=c),"address"==h&&(i=c),"description"==h&&(o=c),"subtitle"==h&&(l=c),"badge"==h&&(n=c),"rating"==h){var f="";for(t=0;t<c;t++)f+=thoriumSqlitePlugin.stars;c=f+"&nbsp;"}u=u.replace(RegExp("{"+h+"}","gi"),c||"")}}d.outerHTML=u})),$(this).css("visibility","visible"),$(".db-map").each((function(e,t){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.sqlite] Load Data for Maps");var d=t.getAttribute("data-engine")||null;if(d||"undefined"==typeof openStreetMapPlugin?d||"undefined"==typeof googleMapPlugin||(d="googlemap"):d="osm",thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.sqlite] Map Engine is ["+d+"]"),"googlemap"==d&&"undefined"!=typeof googleMapPlugin){var u=Base64.encode('[{"name":  "'+a.escapeSpecialChars()+'","lat":  '+s+',"lng":  '+p+',"id":  "","address":  "'+i.escapeSpecialChars()+'","img":  "'+r+'","desc":  "'+o.escapeSpecialChars()+'","subtitle":  "'+l.escapeSpecialChars()+'","badge":  "'+n.escapeSpecialChars()+'"}]');$("#"+t.id).attr("data-markers",u),$("#"+t.id).attr("data-lat",s),$("#"+t.id).attr("data-lng",p),googleMapPlugin.initializeMap(t.id)}else if("osm"==d&&"undefined"!=typeof openStreetMapPlugin){var m=document.getElementById(t.id);if(!m)return;var g={uid:"0",id:"0"};g.name=a,g.address=i,r.length>0?g.locimage="./db/dbassets/"+r:g.locimage="./img/defaultimg.png",g.desc=o,g.subtitle=l,g.badge=n,g.rating="",g.target="",g.latitude=s,g.longitude=p,m.setAttribute("data-lat",s),m.setAttribute("data-lng",p),m.setAttribute("data-zoom",12);var h=openStreetMapPlugin.getMapInstance(t.id);h||(h=openStreetMapPlugin.initMap(t.id)),h&&openStreetMapPlugin.addMarkerAt(h,s,p,g)}}))}))},getdata:function(e,t){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.sqlite] Get data for page ["+t+"| record id: ["+e+"]"),app.preloader.show(),app.request.promise.json(thoriumCorePlugin.httpRoot+"db/webservices/ws_get_data.php",{id:e}).then((function(e){if(e.status&&200!==e.status)app.preloader.hide(),app.emit("dataloadError",$(this),e),1==thoriumCorePlugin.isLocal()?app.dialog.alert("Web Server not Available"):app.dialog.alert(e.status);else{app.preloader.hide();var a=e.data;thoriumSqlitePlugin.setDisplayerContentsFromData(a,t),app.emit("dataloadSuccess",$(this))}})).catch((function(e){app.preloader.hide(),app.emit("dataloadError",$(this),e),app.dialog.alert(e.message)}))},getDataRows:function(e,t,a,r,o,l,n,s){app.preloader.show(),thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.sqlite] Get data for Repeater id: ["+e+"]");var p=$("#"+e);p.removeAttr("data-max");var d=t||0,u=a||0,m=r||"",g=o||null,h=n||0,c=(l=l||null,"");app.request.promise.json(thoriumCorePlugin.httpRoot+"db/webservices/ws_get_data.php",{type:g,search:m,mode:s,limit:d,offset:u,ord:h,parentID:l}).then((function(t){if(t.status&&200!==t.status)return app.emit("dataloadError",$(this),t),1==thoriumCorePlugin.isLocal()?app.dialog.alert("Web Server not Available"):app.dialog.alert(t.status),void app.preloader.hide();app.preloader.hide();var a=t.data;if(a){var r=p.find(".templaterow"),o="";if(!r||!r[0])return app.dialog.alert("Invalid Template"),void app.preloader.hide();o=(o=r[0].outerHTML).replace("templaterow","");var l=0;for(var n in a){var s=a[n],d=o;for(var u in d=o.replace("<div",'<div id="'+r[0].id+"-template-"+l+'" '),s){var m=s[u];if("img_name"==u&&(m=null==m||0==m.length||"null"==m?"./img/transparent.png":thoriumSqlitePlugin.mediaRoot+m),"rating"==u){var g="";for(i=0;i<m;i++)g+=thoriumSqlitePlugin.stars;m=g+"&nbsp;"}d=d.replace(RegExp("{"+u+"}","gi"),m||"")}c+=d,l+=1}if(0==c.length)0==p[0].childElementCount-1?c="<p></p>":p.attr("data-max",!0);p.append(c),$(".repeater").show(),app.preloader.hide(),app.emit("dataloadSuccess",$(this)),thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.sqlite] Succesfully load data for Repeater id: ["+e+"]")}})).catch((function(t){app.emit("dataloadError",$(this),t),app.preloader.hide();var a=t.message||"Unknown Error";thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.sqlite] Get data for Repeater id: ["+e+"] failed: "+t.message+": "+a),app.dialog.alert(t.message+": "+a)}))},loadPlaces:function(e,t){t=t||"googlemap",app.preloader.show();var a=e;"googlemap"==t&&(a=e.getDiv());var i=a.getAttribute("data-limit")||"100",r=a.getAttribute("data-category")||null,o=a.getAttribute("data-target")||"";thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.sqlite] Loading data for "+t),app.request.promise.json(thoriumCorePlugin.httpRoot+"db/webservices/ws_get_data.php",{type:r,limit:i}).then((function(i){if(i.status&&200!==i.status)return app.emit("datamaploadError",$(this)),1==thoriumCorePlugin.isLocal()?app.dialog.alert("Web Server not Available"):app.dialog.alert(i.status),void app.preloader.hide();app.preloader.hide();var r=i.data;if(r)for(var l in app.preloader.show(),r){var n,s=r[l],p=parseFloat(s.latitude),d=parseFloat(s.longitude);"googlemap"==t&&(n=new google.maps.LatLng(p,d));var u=s.name||"",m=parseInt(s.id),g=s.address,h=s.img_name,c=s.description,f=s.subtitle,v=s.badge,P=s.rating;if(0!=p&&0!=d)if("googlemap"==t&&"undefined"!=typeof googleMapPlugin)googleMapPlugin.addMarker(e,n,u,m,g,h,c,f,v,P,o);else if("osm"==t&&"undefined"!=typeof openStreetMapPlugin){var b=e.data;s.target=o,h.length>0&&(s.locimage="./db/dbassets/"+h),s.uid=m,openStreetMapPlugin.addMarkerAt(b,p,d,s)}}a.setAttribute("data-loaded","true"),setTimeout((function(){app.preloader.hide()}),1e3),app.emit("datamaploadSuccess",$(this))})).catch((function(e){app.emit("datamaploadError",$(this)),app.preloader.hide(),thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.sqlite] Loading data for "+t+" failed: "+e.message),app.dialog.alert(e.message)}))},initialize_data:function(e){var t,a,i=null;e===page?a=app.root:(a=e.$el,i=e.route),a&&(i&&(t=i.query.id||null,parseInt(t)>0&&thoriumSqlitePlugin.getdata(t,e)),a.find("[data-repeater=true]").each((function(){if("false"==("true"==$(this).attr("data-loaded")||"false")){var e=$(this).attr("data-limit"),t=$(this).attr("data-type")||null,a=$(this).attr("data-order")||0,r=$(this).attr("data-mode")||0,o=null;i&&null!==(o=i.query.id||null)&&$(this).attr("data-parent",o),$(this).attr("data-loaded","true"),thoriumSqlitePlugin.getDataRows($(this).attr("id"),e,0,"",t,o,a,r)}})))},setsessionid:function(e){var t=app.name,a=new Date;a.setMonth(a.getMonth()+1);var i=t+"="+escape(e)+(a?";expires="+a.toGMTString():"");document.cookie=i},getsessionid:function(){var e=app.name,t=document.cookie.indexOf(e+"="),a=t+e.length+1;if(!t&&e!=document.cookie.substring(0,e.length))return null;if(-1==t)return null;var i=document.cookie.indexOf(";",a);return-1==i&&(i=document.cookie.length),unescape(document.cookie.substring(a,i))},auth_register:function(e){var t=app.form.convertToData(e);if(t){if(0==t.useremail.length||0==t.password.length||0==t.password2.length)return;if(t.password!=t.password2)return $("#password2").focus(),void $("#password2").val("");app.preloader.show(),app.request({url:thoriumCorePlugin.httpRoot+"db/webservices/ws_register.php",async:!0,crossDomain:kCrossDomain,method:"POST",contentType:"multipart/form-data",data:t,timeout:kTimeOut,error(e,t){app.preloader.hide(),app.dialog.alert(`Error ${t} ${e.responseText}`),app.emit("registerError",e.responseText)},complete(a,i){if(app.preloader.hide(),200==i){var r=a.responseText;if(1!=r){var o=e.attr("data-error-message")||"Error";app.emit("registerError",r),app.dialog.alert(o+` (${r})`)}else{var l={useremail:t.useremail,password:t.password};app.form.fillFromData("#auth-signin-form",l),app.view[0].router.back(),app.emit("registerSuccess",e)}}}})}},auth_loadProfile:function(){var e=new FormData;e.append("sessionid",thoriumSqlitePlugin.getsessionid()),app.preloader.show(),app.request({url:thoriumCorePlugin.httpRoot+"db/webservices/ws_get_profile.php",async:!0,crossDomain:kCrossDomain,method:"POST",contentType:"multipart/form-data",data:e,timeout:kTimeOut,error(e,t){app.preloader.hide(),$("#auth-profile-form").hide(),app.dialog.alert(`An error occured (${t}) ${e.statusText}`),app.emit("loadprofileError",e.statusText)},complete(e,t){if(app.preloader.hide(),200==t)if(e.responseText<0)app.preloader.hide(),$("#auth-profile-form").hide(),app.dialog.alert("An error occured. "+e.statusText),app.emit("loadprofileError",e.statusText);else{var a=JSON.parse(e.responseText)[0],i={};for(var r in a){var o=a[r];if("customfields"==r&&o&&o.length>0){var l=JSON.parse(o);for(var n in l){if((s=$("#"+n))&&(i[n]=l[n],"range"==s.attr("type"))){app.range.get(".range-slider");app.range.setValue("#range_"+n,l[n])}}}else{var s;if("id"!=r&&"sessionid"!=r&&"password"!=r)(s=$("#profile_"+r))&&(i["profile_"+r]=o)}}app.form.fillFromData("#auth-profile-form",i),$("#auth-profile-form").show(),app.emit("loadprofileSuccess",thoriumSqlitePlugin.getsessionid())}}})},auth_save_profile:function(e){var t=app.form.convertToData(e),a={},i={};for(var r in t)"profile_username"!=r&&"profile_useremail"!=r&&(i[r]=t[r]);var o=JSON.stringify(i);a.profile_customfields=o,a.profile_username=t.profile_username,a.profile_useremail=t.profile_useremail,a.sessionid=thoriumSqlitePlugin.getsessionid(),a&&(app.preloader.show(),app.request({url:thoriumCorePlugin.httpRoot+"db/webservices/ws_set_profile.php",async:!0,crossDomain:kCrossDomain,method:"POST",contentType:"multipart/form-data",data:a,timeout:kTimeOut,error(e,t){app.preloader.hide(),app.dialog.alert(`Error ${t} ${e.responseText}`),app.emit("saveprofileerror",e.responseText)},complete(t,a){if(app.preloader.hide(),200==a){var i=t.responseText;if(1==i)$("#submit_auth-profile").addClass("disabled"),app.emit("saveprofileSuccess",e);else{var r=e.attr("data-error-message")||"Error";app.dialog.alert(r+` (${i})`),app.emit("saveprofileError",i)}}}}))},auth_signIn:function(e){var t=app.form.convertToData(e);if(t){if(0==t.useremail.length||0==t.password.length)return;app.preloader.show(),app.request({url:thoriumCorePlugin.httpRoot+"db/webservices/ws_signin.php",async:!0,crossDomain:kCrossDomain,method:"POST",contentType:"multipart/form-data",data:t,timeout:kTimeOut,error(e,t){app.preloader.hide(),app.dialog.alert("error "+e.responseText),app.emit("signinError",e.responseText)},complete(t,a){if(app.preloader.hide(),200==a){var i=t.responseText;if(i<0){var r=e.attr("data-error-message")||"Error";app.dialog.alert(r+` (${i})`),app.emit("signinError",i)}else{thoriumSqlitePlugin.setsessionid(i);app;app.view[0].router.back();var o=e.attr("data-page-success")||"";o&&o.length>0?app.view[0].router.navigate("/"+o+"/"):$("#submit_auth-signin").addClass("disabled"),app.emit("signinSuccess",e),$("#auth-profile-form").show()}}}})}},auth_checkSession:function(){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.sqlite] Check Session ID");var e=thoriumSqlitePlugin.getsessionid();if(!e)return setTimeout((function(){$(".apploader").hide(),app.preloader.hide(),$(".preloader-backdrop").removeClass("opaque")}),500),$("#view-main").show(),!1;var t=new FormData;t.append("sessionid",e),app.request({url:thoriumCorePlugin.httpRoot+"db/webservices/ws_signin.php",async:!0,crossDomain:kCrossDomain,method:"POST",contentType:"multipart/form-data",data:t,timeout:kTimeOut,error:(e,t)=>($(".apploader").hide(),$(".preloader-backdrop").removeClass("opaque"),app.preloader.hide(),app.dialog.alert(`Connection failed (${t}) ${e.statusText}`),app.emit("sessionNotValid",e.statusText),$("#view-main").show(),!1),complete(t,a){if(200==a){var i=t.responseText;if(i<0)app.view[0].router.navigate("/"),setTimeout((function(){$(".apploader").hide(),app.preloader.hide(),$(".preloader-backdrop").removeClass("opaque")}),500),app.emit("sessionNotValid",i),$("#view-main").show();else if(e==i){thoriumSqlitePlugin.setsessionid(e);var r=$("#auth-signin-form").attr("data-page-success");r&&r.length>0&&app.view[0].router.navigate("/"+r+"/",{animate:!1}),setTimeout((function(){$(".apploader").hide(),app.preloader.hide(),$(".preloader-backdrop").removeClass("opaque")}),500),app.emit("sessionValid",e),$("#view-main").show()}}}})},auth_logout:function(){thoriumSqlitePlugin.setsessionid(""),app.view[0].router.navigate("/",{animate:!1,reloadAll:!0}),$("#useremail").val(""),$("#password").val(""),$("#submit_auth-signin").removeClass("disabled"),app.emit("logout")},auth_sendPassword:function(e){var t=app.form.convertToData(e);if(t){if(0==t.lostemail.length)return;app.preloader.show(),app.request({url:thoriumCorePlugin.httpRoot+"db/webservices/ws_send_password.php",async:!0,crossDomain:kCrossDomain,method:"POST",contentType:"multipart/form-data",data:t,timeout:kTimeOut,error(e,t){app.preloader.hide(),app.dialog.alert(`An error occured (${t}) ${e.statusText}`),app.emit("sendpasswordError",e.statusText)},complete(e,a){if(app.preloader.hide(),200==a){var i=e.responseText;i<0?(app.preloader.hide(),app.dialog.alert(`Invalid email or error (${i})`),app.emit("sendpasswordError",i)):(app.dialog.alert("An email has been sent to "+t.lostemail),app.emit("sendpasswordSuccess",t.lostemail))}}})}},initialize:function(){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.sqlite] Plugin Loaded succesfully"),1==app.initialized&&(1==app.device.cordova?(thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.sqlite] App is running in Native Hybrid mode, set DB host to ["+kRemoteHost+"]"),thoriumCorePlugin.httpRoot=kRemoteHost,thoriumSqlitePlugin.mediaRoot=kRemoteHost+"db/dbassets/"):1==thoriumCorePlugin.isLocal()?(thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.sqlite] App is running in Local mode, set DB host to ["+kLocalRoot+"]"),thoriumCorePlugin.httpRoot=kLocalRoot,thoriumSqlitePlugin.mediaRoot=kMediaRoot):(thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.sqlite] App is running in PWA mode, set DB host to empty"),thoriumCorePlugin.httpRoot="",thoriumSqlitePlugin.mediaRoot=kRemoteHost+"db/dbassets/"),1==kAuthMode?(setTimeout((function(){thoriumSqlitePlugin.auth_checkSession()}),500),setTimeout((function(){thoriumSqlitePlugin.initialize_data(page)}),1e3)):(thoriumSqlitePlugin.initialize_data(page),$(".apploader").hide()))}};$(document).on("search",".search-repeater",(function(e){event.preventDefault();var t=e.target.value,a=e.target.parentNode.parentNode.parentNode.parentNode,i=$(a).find('[data-repeater="true"]');if(i){i.attr("data-search",t);var r=i.attr("data-limit"),o=i.attr("data-type")||null,l=i.attr("id"),n=$(i).find(".templaterow");$(i).html(n[0].outerHTML);var s=i.attr("data-order")||0,p=i.attr("data-mode")||0,d=i.attr("data-parent")||null;thoriumSqlitePlugin.getDataRows(l,r,0,t,o,d,s,p)}})),$(document).on("click",".input-clear-button",(function(e){var t=e.target.parentNode.parentNode.parentNode.parentNode,a=$(t).find('[data-repeater="true"]');if(a){a.attr("data-search","");var i=a.attr("data-limit"),r=a.attr("data-type")||null,o=a.attr("id"),l=a.attr("data-order")||0,n=a.attr("data-mode")||0,s=a.attr("data-parent")||null,p=$(a).find(".templaterow");$(a).html(p[0].outerHTML),thoriumSqlitePlugin.getDataRows(o,i,0,null,r,s,l,n)}})),$(document).on("click",".db-user-logout",(function(e){event.preventDefault(),app.dialog.confirm("Logout?",thoriumSqlitePlugin.auth_logout)})),$(document).on("submit",".auth-profile-form",(function(e){event.preventDefault(),thoriumSqlitePlugin.auth_save_profile($(this))})),$(document).on("submit",".auth-signin-form",(function(e){event.preventDefault(),thoriumSqlitePlugin.auth_signIn($(this))})),$(document).on("submit",".auth-register-form",(function(e){event.preventDefault(),thoriumSqlitePlugin.auth_register($(this))})),$(document).on("submit",".auth-lostpassword-form",(function(e){event.preventDefault(),thoriumSqlitePlugin.auth_sendPassword($(this))})),$(document).on("page:init",(function(e){$(".auth-profile-form").length>0&&thoriumSqlitePlugin.auth_loadProfile(),thoriumSqlitePlugin.initialize_data(e.detail)})),$(document).on("infinite",(function(e){if(thoriumSqlitePlugin.allowInfinite){var t=e.target;$("#"+t.id).find('[data-repeater="true"]').each((function(e,t){if(thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.sqlite] Loading Additional Data"),!($(this).attr("data-max")||!1)){var a=$(this).attr("data-parent")||null,i=$(this).attr("data-limit"),r=$(this).attr("data-type")||null,o=t.childElementCount-1||0,l=$(this).attr("data-order")||0,n=$(this).attr("data-mode")||0,s=$(this).attr("data-search")||"";i>0&&o>0&&(thoriumSqlitePlugin.allowInfinite=!1,thoriumSqlitePlugin.getDataRows($(this).attr("id"),i,o,s,r,a,l,n),setTimeout((function(){thoriumSqlitePlugin.allowInfinite=!0}),1e3))}}))}})),document.addEventListener("deviceready",thoriumSqlitePlugin.initialize),document.addEventListener("DOMContentLoaded",thoriumSqlitePlugin.initialize);